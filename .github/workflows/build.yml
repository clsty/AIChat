name: Build and Package AIChat Mod

on:
  workflow_dispatch:
  schedule:
    # 每日北京时间 11:00 (即 UTC 时间 03:00) 触发
    - cron: '0 3 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout AIChat
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-complete zip

      - name: Download Unity assemblies from NuGet
        run: |
          # Create a temporary project to download Unity assemblies
          mkdir -p /tmp/unity-deps
          cd /tmp/unity-deps
          
          # Create a project file to download UnityEngine.Modules
          cat > UnityDeps.csproj << 'EOF'
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>netstandard2.0</TargetFramework>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="UnityEngine.Modules" Version="2021.3.33" />
            </ItemGroup>
          </Project>
          EOF
          
          # Restore the packages
          dotnet restore
          
          # Copy Unity assemblies to the build environment
          UNITY_PKG_PATH="$HOME/.nuget/packages/unityengine.modules/2021.3.33/lib/net45"
          TARGET_DIR="${{ github.workspace }}/build-resource/buildenv/mokgamedir/Chill With You_Data/Managed"
          
          # Ensure target directory exists
          mkdir -p "$TARGET_DIR"
          
          cp "$UNITY_PKG_PATH/UnityEngine.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.CoreModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.AnimationModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.AudioModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.IMGUIModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.InputLegacyModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.TextRenderingModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.UIModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.UnityWebRequestModule.dll" "$TARGET_DIR/"
          cp "$UNITY_PKG_PATH/UnityEngine.UnityWebRequestAudioModule.dll" "$TARGET_DIR/"
          
          echo "Successfully downloaded Unity core modules from NuGet"
          echo "Note: UnityEngine.UI.dll is kept in the repository as it is not available on NuGet"
          echo "      and is licensed under Unity Companion License (open source)"

      - name: Build AIChat.dll
        run: |
          make GAME_ROOT="${{ github.workspace }}/build-resource/buildenv/mokgamedir"

      - name: Copy AIChat.dll to assets
        run: |
          cp AIChat/bin/Release/AIChat.dll build-resource/assets/

      - name: Zip Artifact
        run: |
          cd build-resource/assets/
          zip -r ../../AIChatMod.zip .

      - name: Get commit info
        id: info
        run: |
          echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          #echo "hash_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "time=$(git log -1 --date=format-local:'%Y-%m-%d %H:%M:%S UTC' --format='%cd')" >> $GITHUB_OUTPUT
        env:
          TZ: UTC

      - name: Update Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: preview
          name: "Preview Build"
          body: |
            [![Build Status](https://github.com/qzrs777/AIChat/actions/workflows/build.yml/badge.svg)](https://github.com/qzrs777/AIChat/actions/workflows/build.yml)
            此为无固定版本号的预览版本，每日自动构建，也可由维护者手动触发。

            此构建的 Commit 信息：
            - HASH: ${{ steps.info.outputs.hash }}
            - 时间: ${{ steps.info.outputs.time }}
          prerelease: true
          files: AIChatMod.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
